!function(){function e(e,n){var i;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(i=function(e,n){if(!e)return;if("string"==typeof e)return t(e,n);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return t(e,n)}(e))||n&&e&&"number"==typeof e.length){i&&(e=i);var s=0,o=function(){};return{s:o,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,c=!1;return{s:function(){i=e[Symbol.iterator]()},n:function(){var e=i.next();return a=e.done,e},e:function(e){c=!0,r=e},f:function(){try{a||null==i.return||i.return()}finally{if(c)throw r}}}}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{zWIZ:function(t,i,o){"use strict";o.r(i),o.d(i,"ChatPageModule",function(){return we});var r=o("SVse"),a=o("s7LF"),c=o("sZkV"),l=o("iInd"),u=o("mrSG"),p=o("SAju"),g=o("5Lyb"),h=o("8Y7J");function b(e,t){1&e&&(h.Rb(0,"p",3),h.Ac(1," Action Execution in Progress\n"),h.Qb())}function f(e,t){1&e&&(h.Rb(0,"p",4),h.Ac(1," Action Execution Success\n"),h.Qb())}function d(e,t){1&e&&(h.Rb(0,"p",5),h.Ac(1," Action Execution Failure\n"),h.Qb())}var m,v,y=((m=function(){function e(t,i){var s=this;n(this,e),this.chatActionService=t,this.route=i,this.executionStatus="in_progress",this.getActionFromParams().then(function(e){s.actionType=e.type,s.actionJSON=JSON.stringify(e),s.chatActionService.executeChatAction(e).then(function(){s.executionStatus="success"},function(e){s.executionStatus="failure",s.debugMsg="Failed: "+e})},function(e){s.debugMsg="Failed to create action: "+e})}return s(e,[{key:"getActionFromParams",value:function(){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=this.route.snapshot.paramMap.get("actionType"))||!p.a[t]){e.next=3;break}return e.abrupt("return",{type:t,executed:!1,params:this.route.snapshot.queryParams});case 3:throw"No chat action with type "+t;case 4:case"end":return e.stop()}},e,this)}))}},{key:"ngOnInit",value:function(){}}]),e}()).\u0275fac=function(e){return new(e||m)(h.Mb(g.a),h.Mb(l.a))},m.\u0275cmp=h.Gb({type:m,selectors:[["plh-chat-action"]],decls:9,vars:6,consts:[["style","color: yellow",4,"ngIf"],["style","color: green",4,"ngIf"],["style","color: red",4,"ngIf"],[2,"color","yellow"],[2,"color","green"],[2,"color","red"]],template:function(e,t){1&e&&(h.Rb(0,"p"),h.Ac(1),h.Qb(),h.Rb(2,"p"),h.Ac(3),h.Qb(),h.yc(4,b,2,0,"p",0),h.yc(5,f,2,0,"p",1),h.yc(6,d,2,0,"p",2),h.Rb(7,"p"),h.Ac(8),h.Qb()),2&e&&(h.Ab(1),h.Cc(" Chat Action: ",t.actionType,"\n"),h.Ab(2),h.Cc(" Action JSON: ",t.actionJSON,"\n"),h.Ab(1),h.ic("ngIf","in_progress"==t.executionStatus),h.Ab(1),h.ic("ngIf","success"==t.executionStatus),h.Ab(1),h.ic("ngIf","failure"==t.executionStatus),h.Ab(2),h.Cc(" ",t.debugMsg,"\n"))},directives:[r.l],styles:[""]}),m),w=o("gcOT"),x=o("Qpa5"),k=o("7zx7"),O=o("i+cc"),S=o("YVjz"),M=o("GJmQ"),A=o("IHle"),R=((v=function(){function e(t){n(this,e),this.notificationService=t,this.type="online",this.messages$=new k.a([]),this.ready$=new k.a(!1),this.init()}return s(e,[{key:"ready",value:function(){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.ready$.pipe(Object(M.a)(function(e){return!1===e})).toPromise());case 1:case"end":return e.stop()}},e,this)}))}},{key:"init",value:function(){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=w.a.isNative,!e.t0){e.next=5;break}return e.next=4,this.notificationService.init();case 4:this.ready$.next(!0);case 5:case"end":return e.stop()}},e,this)}))}},{key:"startFlowByName",value:function(e){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function t(){var n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.messages$.complete(),this.messages$=new k.a([]),this.subscription&&this.subscription.unsubscribe(),this.subscription=this.notificationService.messages$.subscribe(function(e){Object(A.a)(e).then(function(e){n.messages$.next(n.messages$.getValue().concat([e]))})},function(e){n.messages$.error(e)}),t.next=6,this.notificationService.sendRapidproMessage(e);case 6:return t.abrupt("return",this.messages$);case 7:case"end":return t.stop()}},t,this)}))}},{key:"sendMessage",value:function(e){return Object(O.a)(this.notificationService.sendRapidproMessage(e.text))}}]),e}()).\u0275fac=function(e){return new(e||v)(h.Vb(S.a))},v.\u0275prov=h.Ib({token:v,factory:v.\u0275fac,providedIn:"root"}),v),C=o("Tesu"),I=o("Jr/a"),N=o("NiZn");function _(e,t){if(1&e&&h.Nb(0,"img",5),2&e){var n=h.cc().$implicit;h.ic("src",n.imageUrl,h.sc)}}var P=function(e){return{large:e}};function Q(e,t){if(1&e){var n=h.Sb();h.Rb(0,"div",3),h.Zb("click",function(){h.qc(n);var e=t.$implicit;return h.cc().selectResponseOption(e)}),h.yc(1,_,1,1,"img",4),h.Rb(2,"span"),h.Ac(3),h.Qb(),h.Qb()}if(2&e){var i=t.$implicit;h.ic("ngClass",h.lc(3,P,i.text.length<2)),h.Ab(1),h.ic("ngIf",i.imageUrl),h.Ab(2),h.Bc(i.text)}}var F,T=((F=function(){function e(t){n(this,e),this.modalController=t,this.onOptionSelect=new h.o}return s(e,[{key:"ngOnInit",value:function(){}},{key:"selectResponseOption",value:function(e){this.onOptionSelect.emit(e),this.modalController.dismiss()}}]),e}()).\u0275fac=function(e){return new(e||F)(h.Mb(c.G))},F.\u0275cmp=h.Gb({type:F,selectors:[["plh-responses-modal"]],inputs:{responseOptions:"responseOptions"},outputs:{onOptionSelect:"onOptionSelect"},decls:3,vars:1,consts:[[1,"chat-responses-modal"],[1,"response-options"],["class","response-option",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"response-option",3,"ngClass","click"],[3,"src",4,"ngIf"],[3,"src"]],template:function(e,t){1&e&&(h.Rb(0,"div",0),h.Rb(1,"div",1),h.yc(2,Q,4,5,"div",2),h.Qb(),h.Qb()),2&e&&(h.Ab(2),h.ic("ngForOf",t.responseOptions))},directives:[r.k,r.j,r.l],styles:[".response-options[_ngcontent-%COMP%]{align-self:flex-end;width:100%;display:flex;flex-wrap:wrap;padding:16px}.response-option[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center;color:var(--ion-primary-color,#0d4060);background-color:#fff;padding:7px;font-size:14px;margin:10px;border-radius:20px;border:3px solid var(--ion-primary-color,#0d4060);white-space:nowrap}.response-option[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{text-align:center}.response-option.large[_ngcontent-%COMP%]{font-size:40px;border-radius:40px}.response-option[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-height:150px}"]}),F);function j(e,t){1&e&&h.Nb(0,"ion-icon",6)}var E=function(e){return{ticked:e}};function $(e,t){if(1&e){var n=h.Sb();h.Rb(0,"div",4),h.Zb("click",function(){h.qc(n);var e=h.cc(2);return e.ticked=!e.ticked}),h.yc(1,j,1,0,"ion-icon",5),h.Qb()}if(2&e){var i=h.cc(2);h.ic("ngClass",h.lc(2,E,i.ticked)),h.Ab(1),h.ic("ngIf",i.ticked)}}function B(e,t){if(1&e&&h.Nb(0,"img",10),2&e){var n=h.cc().$implicit;h.ic("src",n.imageUrl,h.sc)}}function V(e,t){if(1&e&&(h.Rb(0,"span"),h.Ac(1),h.Qb()),2&e){var n=h.cc().$implicit;h.Ab(1),h.Bc(n.text)}}function L(e,t){if(1&e){var n=h.Sb();h.Rb(0,"div",7),h.Zb("click",function(){h.qc(n);var e=t.$implicit;return h.cc(2).selectResponseOption(e)}),h.yc(1,B,1,1,"img",8),h.yc(2,V,2,1,"span",9),h.Qb()}if(2&e){var i=t.$implicit;h.Ab(1),h.ic("ngIf",i.imageUrl),h.Ab(1),h.ic("ngIf",!i.hideText)}}function z(e,t){if(1&e&&(h.Rb(0,"div",1),h.yc(1,$,2,4,"div",2),h.yc(2,L,3,2,"div",3),h.Qb()),2&e){var n=h.cc();h.Ab(1),h.ic("ngIf",n.message.displayAsTick),h.Ab(1),h.ic("ngForOf",n.getResponseOptions())}}var D,U=((D=function(){function e(t,i){var s=this;n(this,e),this.modalController=t,this.settingsService=i,this.ticked=!0,this.onOptionSelect=new h.o,this.useModal=!1,this.settingsService.getUserSetting("USE_MODAL_FOR_CHAT_RESPONSES").subscribe(function(e){s.useModal="true"===e})}return s(e,[{key:"ngOnChanges",value:function(e){this.useModal&&e.responseOptions&&e.responseOptions.currentValue&&e.responseOptions.currentValue.length>0&&this.modalController.create({component:T,componentProps:{responseOptions:this.responseOptions,message:this.message,onOptionSelect:this.onOptionSelect},cssClass:"slide-up-modal",backdropDismiss:!1,swipeToClose:!1}).then(function(e){return e.present()}),e.message.currentValue!==e.message.previousValue&&(this.ticked=!!this.message.tickedByDefault)}},{key:"selectResponseOption",value:function(e){this.onOptionSelect.emit(e)}},{key:"getResponseOptions",value:function(){return this.message&&this.message.displayAsTick&&this.message.responseOptions.length>=2?this.ticked?[this.message.responseOptions[0]]:[this.message.responseOptions[1]]:this.message.responseOptions}}]),e}()).\u0275fac=function(e){return new(e||D)(h.Mb(c.G),h.Mb(C.a))},D.\u0275cmp=h.Gb({type:D,selectors:[["plh-chat-responses"]],inputs:{responseOptions:"responseOptions",message:"message"},outputs:{onOptionSelect:"onOptionSelect"},features:[h.yb],decls:1,vars:1,consts:[["class","response-options",4,"ngIf"],[1,"response-options"],["class","checkbox",3,"ngClass","click",4,"ngIf"],["class","response-option",3,"click",4,"ngFor","ngForOf"],[1,"checkbox",3,"ngClass","click"],["name","checkmark-outline",4,"ngIf"],["name","checkmark-outline"],[1,"response-option",3,"click"],[3,"src",4,"ngIf"],[4,"ngIf"],[3,"src"]],template:function(e,t){1&e&&h.yc(0,z,3,2,"div",0),2&e&&h.ic("ngIf",!t.useModal)},directives:[r.l,r.k,r.j,c.l],styles:["[_nghost-%COMP%]{background:hsla(0,0%,100%,.7)}.response-options[_ngcontent-%COMP%]{max-height:50vh;align-self:flex-end;width:100%;display:flex;flex-wrap:wrap;padding:16px;overflow:auto}.response-option[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center;color:var(--ion-primary-color,#0d4060);background-color:#fff;padding:7px;font-size:14px;margin:10px;border-radius:20px;border:3px solid var(--ion-primary-color,#0d4060);min-width:25vw}.response-option[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{text-align:center}.response-option.large[_ngcontent-%COMP%]{font-size:40px;border-radius:40px}.response-option[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-height:150px}.checkbox[_ngcontent-%COMP%]{margin:10px;width:40px;height:40px;border-radius:10px;border:3px solid var(--ion-primary-color,#0d4060)}.checkbox.ticked[_ngcontent-%COMP%]{background-color:var(--ion-primary-color,#0d4060);color:#fff}.checkbox[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{width:100%;height:100%}"]}),D),J=["normalChatEnd"];function Z(e,t){if(1&e){var n=h.Sb();h.Rb(0,"div",14),h.Rb(1,"ion-button",15),h.Zb("click",function(){return h.qc(n),h.cc(2).modalCtrl.dismiss()}),h.Nb(2,"ion-icon",16),h.Qb(),h.Qb()}}function G(e,t){if(1&e&&(h.Rb(0,"div",17),h.Rb(1,"p"),h.Ac(2),h.Qb(),h.Rb(3,"p"),h.Ac(4),h.Qb(),h.Rb(5,"p"),h.Ac(6),h.Qb(),h.Rb(7,"p"),h.Ac(8),h.Qb(),h.Qb()),2&e){var n=h.cc(2);h.Ab(2),h.Cc("Messages Sent ",n.messagesSent,""),h.Ab(2),h.Cc("Messages Received ",n.messagesReceived,""),h.Ab(2),h.Bc(n.debugMsg),h.Ab(2),h.Bc(n.stringify(n.messages[n.messages.length-1]))}}function q(e,t){if(1&e&&(h.Rb(0,"div"),h.Rb(1,"p"),h.Ac(2),h.Qb(),h.Qb()),2&e){var n=h.cc(2);h.Ab(2),h.Dc("Flow Name: ",null==n.latestFlowEvent?null:n.latestFlowEvent.name," : ",null==n.latestFlowEvent?null:n.latestFlowEvent.status,"")}}function H(e,t){if(1&e&&(h.Rb(0,"div"),h.Nb(1,"img",25),h.Qb()),2&e){var n=h.cc().$implicit;h.Ab(1),h.ic("src","assets/plh_assets/plh_images/characters/"+n.character.toLowerCase().trim()+"/neutral.svg",h.sc)}}function W(e,t){1&e&&(h.bc(),h.Rb(0,"svg",26),h.Nb(1,"path",27),h.Qb())}function K(e,t){if(1&e&&h.Nb(0,"div",28),2&e){var n=h.cc().$implicit;h.ic("innerHTML",n.text,h.rc)}}function Y(e,t){if(1&e&&h.Nb(0,"img",29),2&e){var n=h.cc().$implicit;h.ic("src",n.innerImageUrl,h.sc)}}function X(e,t){1&e&&(h.bc(),h.Rb(0,"svg",30),h.Nb(1,"path",31),h.Qb())}function ee(e,t){if(1&e&&h.Nb(0,"img",29),2&e){var n=h.cc().$implicit;h.ic("src",n.url,h.sc)}}function te(e,t){1&e&&(h.Rb(0,"div",32),h.yc(1,ee,1,1,"img",33),h.Qb()),2&e&&(h.ic("ngSwitch",t.$implicit.type),h.Ab(1),h.ic("ngSwitchCase","image"))}var ne=function(e,t){return{bot:e,user:t}};function ie(e,t){if(1&e&&(h.Rb(0,"div"),h.yc(1,H,2,1,"div",8),h.Rb(2,"div",18),h.yc(3,W,2,0,"svg",19),h.Rb(4,"div",20),h.yc(5,K,1,1,"div",21),h.yc(6,Y,1,1,"img",22),h.Qb(),h.yc(7,X,2,0,"svg",23),h.Qb(),h.yc(8,te,2,2,"div",24),h.Qb()),2&e){var n=t.$implicit,i=t.index,s=h.cc(2);h.Cb("bot"===n.sender?"msg-container bot-msg":"msg-container user-msg"),h.Ab(1),h.ic("ngIf",n.character&&!s.sameAsLastCharacter(n,s.messages[i-1])),h.Ab(1),h.ic("ngClass",h.mc(9,ne,"bot"===n.sender,"user"===n.sender)),h.Ab(1),h.ic("ngIf","bot"===n.sender),h.Ab(2),h.ic("ngIf",!n.hideText),h.Ab(1),h.ic("ngIf",n.innerImageUrl),h.Ab(1),h.ic("ngIf","user"===n.sender),h.Ab(1),h.ic("ngForOf",n.attachments)}}function se(e,t){if(1&e&&h.Nb(0,"ng-lottie",34),2&e){var n=h.cc(2);h.ic("options",n.typingAnimOptions)}}function oe(e,t){if(1&e){var n=h.Sb();h.Rb(0,"plh-chat-responses",35),h.Zb("onOptionSelect",function(e){return h.qc(n),h.cc(2).selectResponseOption(e)}),h.Qb()}if(2&e){var i=h.cc(2);h.ic("responseOptions",null==i.lastReceivedMsg?null:i.lastReceivedMsg.responseOptions)("message",i.lastReceivedMsg)}}function re(e,t){if(1&e&&(h.Rb(0,"div",2),h.yc(1,Z,3,0,"div",3),h.Rb(2,"div",4,5),h.Rb(4,"div",6),h.yc(5,G,9,4,"div",7),h.yc(6,q,3,2,"div",8),h.yc(7,ie,9,12,"div",9),h.yc(8,se,1,1,"ng-lottie",10),h.Qb(),h.Nb(9,"div",null,11),h.Nb(11,"div",12),h.Qb(),h.yc(12,oe,1,2,"plh-chat-responses",13),h.Qb()),2&e){var n=h.cc();h.Ab(1),h.ic("ngIf",n.isModal),h.Ab(4),h.ic("ngIf",n.autoReplyEnabled),h.Ab(1),h.ic("ngIf",n.showFlowName&&n.latestFlowEvent),h.Ab(1),h.ic("ngForOf",n.messages),h.Ab(1),h.ic("ngIf",n.botTyping),h.Ab(4),h.ic("ngIf",n.lastReceivedMsg)}}function ae(e,t){if(1&e){var n=h.Sb();h.Rb(0,"div",42),h.Zb("click",function(){return h.qc(n),h.cc(3).onStoryPreviousClicked()}),h.Ac(1," Previous "),h.Qb()}}function ce(e,t){if(1&e){var n=h.Sb();h.Rb(0,"div",42),h.Zb("click",function(){return h.qc(n),h.cc(3).onStoryNextClicked()}),h.Ac(1," Next "),h.Qb()}}function le(e,t){if(1&e&&(h.Rb(0,"div",40),h.yc(1,ae,2,0,"div",41),h.yc(2,ce,2,0,"div",41),h.Qb()),2&e){var n=t.$implicit;h.Ab(1),h.ic("ngIf","previous"===n.text.toLowerCase()),h.Ab(1),h.ic("ngIf","previous"!==n.text.toLowerCase())}}function ue(e,t){if(1&e&&(h.Rb(0,"div",36),h.Nb(1,"div",37),h.Rb(2,"div",38),h.yc(3,le,3,2,"div",39),h.Qb(),h.Qb()),2&e){var n=h.cc();h.Ab(1),h.ic("innerHTML",n.lastReceivedMsg.text,h.rc),h.Ab(2),h.ic("ngForOf",n.responseOptions)}}var pe,ge,he,be,fe=((ge=function(){function t(e,i,s,o,r,a,c,l,u,p){n(this,t),this.cd=e,this.route=i,this.router=s,this.chatActionService=o,this.settingsService=r,this.offlineChatService=a,this.onlineChatService=c,this.modalCtrl=l,this.alertController=u,this.contactFieldService=p,this.messages=[],this.allMessages=[],this.showFlowSkip=!0,this.responseOptions=[],this.botBlobState="walking-in",this.backgroundBlobVisible=!1,this.botAnimOptions={loop:!1,path:"/assets/lottie-animations/Walk_In_Entrance_Pass_v2.json"},this.autoReplyEnabled=!1,this.autoReplyDelay=500,this.autoReplyWord="N",this.autoRepeatPhrase="Repeat simulation",this.autoEndPhrase="THE END",this.messagesSent=0,this.messagesReceived=0,this.debugMsg="testing???",this.sentResponsesByMessage={},this.inputValue="",this.showingAllMessages=!0,this.character="guide",this.chatViewType="normal",this.showFlowName=!1,this.botTyping=!1,this.typingAnimOptions={path:"assets/lottie-animations/3759-typing.json",loop:!0,autoplay:!0}}return s(t,[{key:"ionViewDidEnter",value:function(){var e=this;this.checkIsModal(),this.processRouteParams(),this.processRouteQueryParams(),this.initChatService().then(function(){e.startFlow(e.flowName)})}},{key:"initChatService",value:function(){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.chatService=this.offlineChatService,this.offlineChatService.botTyping$.subscribe(function(e){t.botTyping=e}),"offline"===this.chatService.type&&(this.offlineChatService.flowStatus$.subscribe(function(e){e.length>0&&(t.latestFlowEvent=e[e.length-1])}),this.settingsService.getUserSetting("SHOW_FLOW_NAME").subscribe(function(e){t.showFlowName="true"===e})),console.log("%cUsing ".concat(this.chatService.type," chat "),"color: #9c9c9c");case 1:case"end":return e.stop()}},e,this)}))}},{key:"showCustomInputAlert",value:function(){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t,n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.alertController.create({header:this.lastReceivedMsg.text,inputs:[{type:"text"}],buttons:[{text:"Submit",handler:function(e){n.sendCustomOption(e[0])}}]});case 2:return t=e.sent,e.next=5,t.present();case 5:case"end":return e.stop()}},e,this)}))}},{key:"checkIsModal",value:function(){var e=this;this.modalCtrl.getTop().then(function(t){return e.isModal=!!t})}},{key:"processRouteParams",value:function(){var e=this.route.snapshot.params;e.flowName&&(this.flowName=e.flowName)}},{key:"processRouteQueryParams",value:function(){var e=this.route.snapshot.queryParams;this.character=e.character||"guide"}},{key:"startFlow",value:function(t){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){var i=this;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.chatService.ready();case 2:t?(this.chatService.startFlowByName(t),this.messageSubscription=this.chatService.messages$.subscribe(function(t){if(t.length>0){var n=t[t.length-1];if(n.actions&&n.actions.length>0){var s,o=e(n.actions);try{for(o.s();!(s=o.n()).done;){var r=s.value;i.chatActionService.executeChatAction(r)}}catch(a){o.e(a)}finally{o.f()}}i.onNewMessage(n)}})):console.error("no flow name specified");case 3:case"end":return n.stop()}},n,this)}))}},{key:"ionViewDidLeave",value:function(){this.messageSubscription.unsubscribe()}},{key:"onNewMessage",value:function(e){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function t(){var n,i,s=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("new Message",e),e.dateReceived=new Date,this.lastReceivedMsg=e,!(e.character&&e.character.toLowerCase().indexOf("guide")>-1)){t.next=5;break}return t.next=3,this.contactFieldService.getContactField("guidenumber");case 3:(n=t.sent)&&(e.character=n);case 5:e.isStory?this.chatViewType="story":(this.chatViewType="normal",this.allMessages.push(e),this.messages=this.showingAllMessages?this.allMessages:this.allMessages.slice(this.allMessages.length-2)),"bot"===e.sender?(this.responseOptions=e.responseOptions?e.responseOptions:[],e.showTextInput&&this.showCustomInputAlert()):this.responseOptions=[],i=100,(e.attachments&&e.attachments.length>0||e.innerImageUrl)&&(i=1e3),setTimeout(function(){s.chatEndDiv&&s.chatEndDiv.nativeElement.scrollIntoView({behavior:"smooth",block:"end"})},i),this.cd.detectChanges();case 8:case"end":return t.stop()}},t,this)}))}},{key:"doCustomResponseAction",value:function(e){var t=this;"bot-leave"===e?(this.botAnimOptions={loop:!1,path:"/assets/lottie-animations/Walk_Out_Exit_Pass_v2.json"},this.botBlobState="walking-out",setTimeout(function(){return t.botBlobState="absent"},4200)):"bot-run-back"===e?(this.botBlobState="run-in",this.botAnimOptions={loop:!1,path:"/assets/lottie-animations/Run_In_Entrance_Pass_v2.json"},setTimeout(function(){return t.botBlobState="still"},3200)):"bot-walk-back"===e&&(this.botBlobState="walking-in",this.botAnimOptions={loop:!1,path:"/assets/lottie-animations/Walk_In_Entrance_Pass_v2.json"},setTimeout(function(){return t.botBlobState="still"},3200))}},{key:"onInputSubmit",value:function(e){this.sendCustomOption(this.inputValue),this.inputValue=""}},{key:"sendCustomOption",value:function(e){this.onNewMessage({text:e,sender:"user"}),this.chatService.sendMessage({text:e,sender:"user"}),this.messagesSent+=1}},{key:"selectResponseOption",value:function(e){var t=e.text;e.customAction&&this.doCustomResponseAction(e.customAction);var n={text:t,sender:"user"};e.hideText&&(n.hideText=!0),e.imageUrl&&(n.innerImageUrl=e.imageUrl),this.onNewMessage(n),this.chatService.sendMessage({text:t,sender:"user"}),this.messagesSent+=1}},{key:"toggleShowAllMessages",value:function(){this.showingAllMessages?(this.messages=this.allMessages.slice(this.allMessages.length-2),this.showingAllMessages=!1):(this.messages=this.allMessages,this.showingAllMessages=!0)}},{key:"stringify",value:function(e){return JSON.stringify(e)}},{key:"skipFlow",value:function(){this.router.navigateByUrl("/home")}},{key:"sameAsLastCharacter",value:function(e,t){if(t){var n=this.allMessages.filter(function(e){return"bot"===e.sender}).reverse().slice(0,2);if(2===n.length)return n[0].character===n[1].character}return!1}},{key:"onStoryNextClicked",value:function(){this.chatService.sendMessage({sender:"user",text:"Next"})}},{key:"onStoryPreviousClicked",value:function(){this.chatService.sendMessage({sender:"user",text:"Previous"})}}]),t}()).\u0275fac=function(e){return new(e||ge)(h.Mb(h.i),h.Mb(l.a),h.Mb(l.h),h.Mb(g.a),h.Mb(C.a),h.Mb(x.a),h.Mb(R),h.Mb(c.G),h.Mb(c.a),h.Mb(I.a))},ge.\u0275cmp=h.Gb({type:ge,selectors:[["app-chat"]],viewQuery:function(e,t){var n;1&e&&h.Fc(J,!0),2&e&&h.nc(n=h.ac())&&(t.chatEndDiv=n.first)},inputs:{flowName:"flowName"},decls:2,vars:2,consts:[["class","container",4,"ngIf"],["class","story-chat",4,"ngIf"],[1,"container"],["class","close-button-container",4,"ngIf"],[1,"normal-chat"],["messagesContent",""],[1,"messages"],["class","auto-reply-container",4,"ngIf"],[4,"ngIf"],[3,"class",4,"ngFor","ngForOf"],["class","typing-anim",3,"options",4,"ngIf"],["normalChatEnd",""],[2,"display","block","height","50px"],[3,"responseOptions","message","onOptionSelect",4,"ngIf"],[1,"close-button-container"],["fill","clear",3,"click"],["slot","icon-only","name","close"],[1,"auto-reply-container"],[1,"msg-bubble-container",3,"ngClass"],["class","bot-msg-triangle","width","15","height","20","viewBox","0 0 15 20","fill","none","xmlns","http://www.w3.org/2000/svg",4,"ngIf"],[1,"msg-bubble"],[3,"innerHTML",4,"ngIf"],[3,"src",4,"ngIf"],["class","user-msg-triangle","width","15","height","20","viewBox","0 0 15 20","fill","none","xmlns","http://www.w3.org/2000/svg",4,"ngIf"],["class","msg-attachment",3,"ngSwitch",4,"ngFor","ngForOf"],[1,"character-image",3,"src"],["width","15","height","20","viewBox","0 0 15 20","fill","none","xmlns","http://www.w3.org/2000/svg",1,"bot-msg-triangle"],["d","M15 20V0L0 10L15 20Z","fill","grey"],[3,"innerHTML"],[3,"src"],["width","15","height","20","viewBox","0 0 15 20","fill","none","xmlns","http://www.w3.org/2000/svg",1,"user-msg-triangle"],["d","M0 20V0L15 10L0 20Z","fill","darkcyan"],[1,"msg-attachment",3,"ngSwitch"],[3,"src",4,"ngSwitchCase"],[1,"typing-anim",3,"options"],[3,"responseOptions","message","onOptionSelect"],[1,"story-chat"],[1,"story-msg-text",3,"innerHTML"],[1,"response-options"],["class","response-option",4,"ngFor","ngForOf"],[1,"response-option"],[3,"click",4,"ngIf"],[3,"click"]],template:function(e,t){1&e&&(h.yc(0,re,13,6,"div",0),h.yc(1,ue,4,2,"div",1)),2&e&&(h.ic("ngIf",!(null!=t.lastReceivedMsg&&t.lastReceivedMsg.isStory)),h.Ab(1),h.ic("ngIf",null==t.lastReceivedMsg?null:t.lastReceivedMsg.isStory))},directives:[r.l,r.k,c.d,c.l,r.j,r.n,r.o,N.a,U],styles:[".messages{padding:10px}.container,.messages{display:flex;flex-direction:column}.container{height:100%;width:100%}.close-button-container{margin-left:auto}.normal-chat{flex-grow:1;overflow-y:auto}.story-msg-text p{text-align:center}.block-image{display:block}.story-chat{flex-grow:1;overflow-y:auto;background-color:#ffff83;opacity:1;-webkit-animation-name:fadeInOpacity;animation-name:fadeInOpacity;-webkit-animation-iteration-count:1;animation-iteration-count:1;-webkit-animation-timing-function:ease-in;animation-timing-function:ease-in;-webkit-animation-duration:1s;animation-duration:1s}.story-chat h1{margin:30px}.story-chat .response-options{justify-content:center}.story-chat .block-image{border-radius:30px;max-height:300px;margin-left:auto;margin-right:auto;display:block}@-webkit-keyframes fadeInOpacity{0%{opacity:0}to{opacity:1}}@keyframes fadeInOpacity{0%{opacity:0}to{opacity:1}}.bot-blob{width:100%;height:100px;padding:5px}.bot-blob .bot-lottie{position:absolute;left:-50px;top:0;z-index:12}.bot-blob .still-bot-blob{width:30vw;position:absolute;left:49.7vw;top:3.8vw;z-index:11}@-webkit-keyframes shrink{0%{left:-75vw;width:150vw}50%{left:-75vw;width:150vw}to{left:-25vw;width:50vw}}@keyframes shrink{0%{left:-75vw;width:150vw}50%{left:-75vw;width:150vw}to{left:-25vw;width:50vw}}.msg-container{margin-bottom:20px}.msg-container .msg-bubble-container{display:flex;flex-direction:row;align-items:center}.msg-container .msg-bubble-container.user{justify-content:flex-end}.msg-container .msg-attachment>img{max-width:50vw;border:0;border-radius:20px;max-height:40vh;padding:16px}.msg-container .msg-bubble{background-color:var(--theme-var-botMsgBubble,#cae6fc);color:var(--ion-color-dark,#000);padding:16px;font-size:16px;border-radius:10px;box-shadow:4px 4px 6px grey;white-space:break-spaces}.msg-container .msg-bubble img{height:100px}.msg-container .msg-bubble .icon,.msg-container .msg-bubble .inline-image{max-height:30px}.msg-container .msg-bubble .block-image{display:block;max-height:100px}.msg-container .msg-bubble.large{font-size:40px}.msg-container.bot-msg .msg-bubble{background-color:var(--theme-var-botMsgBubble,#cae6fc)}.msg-container.user-msg .msg-bubble{background-color:var(--theme-var-userMsgBubble,#e9ebeb)}.msg-container .user-msg-triangle>path{z-index:2;fill:var(--theme-var-userMsgBubble,#e9ebeb)}.msg-container .bot-msg-triangle>path{z-index:2;fill:var(--theme-var-botMsgBubble,#cae6fc)}.msg-container.user-msg{justify-content:flex-end}.msg-container .arrow{margin:0}.response-options{max-height:50vh;align-self:flex-end;width:100%;display:flex;flex-wrap:wrap;padding:16px}.response-option{display:flex;flex-direction:column;justify-content:center;color:var(--ion-primary-color,#0d4060);background-color:#fff;padding:7px;font-size:14px;margin:10px;border-radius:20px;border:3px solid var(--ion-primary-color,#0d4060);white-space:nowrap}.response-option span{text-align:center}.response-option.large{font-size:40px;border-radius:40px}.response-option img{max-height:150px}.user-blob{position:absolute;bottom:20px;right:20px;z-index:3}.custom-input{color:#008b8b;background-color:transparent;padding:15px;font-size:20px;margin:20px;border-radius:30px;border:3px solid #008b8b;width:calc(100vw - 100px)}.show-all-button{position:absolute;left:5px;bottom:5px;z-index:20;color:#333;border:1px solid #333;border-radius:10px;display:inline;padding:8px;opacity:.8}.auto-reply-container{display:block;font-size:.6em}.skip-button{margin:16px}.typing-anim{width:60px}.character-image{max-height:120px}"],encapsulation:2}),ge),de=((pe=function(){function e(t,i){n(this,e),this.alertController=t,this.chatService=i}return s(e,[{key:"canDeactivate",value:function(e,t,n,i){return Object(u.a)(this,void 0,void 0,regeneratorRuntime.mark(function t(){var n,i,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e.lastReceivedMsg&&e.lastReceivedMsg.actions&&e.lastReceivedMsg.actions.find(function(e){return e.type===p.a.NAVIGATE}))){t.next=2;break}return t.abrupt("return",!0);case 2:if(n=this.chatService.flowStatus$.getValue(),!(i=n[n.length-1])||"completed"!==i.status){t.next=5;break}return t.abrupt("return",!0);case 5:return t.next=7,this.alertController.create({header:"Are you sure you want to leave?",message:"If you leave part way through you will lose your progress",buttons:[{text:"OK",role:"ok"},{text:"Cancel",role:"cancel"}]});case 7:return(s=t.sent).present(),t.next=11,s.onDidDismiss();case 11:return t.t0=t.sent.role,t.abrupt("return","ok"===t.t0);case 13:case"end":return t.stop()}},t,this)}))}}]),e}()).\u0275fac=function(e){return new(e||pe)(h.Vb(c.a),h.Vb(x.a))},pe.\u0275prov=h.Ib({token:pe,factory:pe.\u0275fac}),pe),me=[{path:"",redirectTo:"chat_content_flow"},{path:"action/:actionType",component:y},{path:":flowName",component:fe,canDeactivate:[de]}],ve=((he=function e(){n(this,e)}).\u0275mod=h.Kb({type:he}),he.\u0275inj=h.Jb({factory:function(e){return new(e||he)},imports:[[l.j.forChild(me)],l.j]}),he),ye=o("PCNd"),we=((be=function e(){n(this,e)}).\u0275mod=h.Kb({type:be}),be.\u0275inj=h.Jb({factory:function(e){return new(e||be)},providers:[de],imports:[[r.c,a.b,c.D,ye.a,ve,N.b]]}),be)}}])}();